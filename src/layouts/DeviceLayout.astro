---
/**
 * DeviceLayout.astro — thin base shell for all device pages.
 *
 * Structure (same order for every device):
 *   Hero → BigStatement → [MDX body via slot] → Decisions → Specs
 *   → Gallery → Related → Product CTA → Back
 *
 * The MDX body (<slot />) is where all unique per-device content lives:
 * custom graphic components, service sections, architecture prose.
 * This layout handles only data-driven sections from frontmatter.
 */
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

import Layout           from '../components/Layout.astro';
import HeroProduct      from '../components/HeroProduct.astro';
import BigStatement     from '../components/BigStatement.astro';
import FlagshipDecisions from '../components/FlagshipDecisions.astro';
import SpecsTable       from '../components/SpecsTable.astro';
import Gallery          from '../components/Gallery.astro';
import RelatedProducts  from '../components/RelatedProducts.astro';
import Reveal           from '../components/Reveal.astro';
import BackToTop        from '../components/BackToTop.astro';

interface Props {
  entry: CollectionEntry<'devices'>;
}

const { entry } = Astro.props;
const { data }  = entry;
const { Content } = await render(entry);

// Fetch related devices internally — no need to pass from [slug].astro
const allDevices = await getCollection('devices');

const hasDecisions = data.decisions.chose.length > 0
                   || data.decisions.tradeoffs.length > 0
                   || data.decisions.next.length > 0;

const related = allDevices
  .filter(d => d.slug !== entry.slug)
  .map(d => ({ d, score: d.data.tags.filter(t => data.tags.includes(t)).length }))
  .filter(({ score }) => score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 3)
  .map(({ d }) => ({
    slug:     d.slug,
    name:     d.data.name,
    headline: d.data.headline,
    type:     d.data.type,
    status:   d.data.status,
    role:     d.data.role,
    services: d.data.services,
    tags:     d.data.tags,
    photo:    d.data.photos?.[0],
  }));

const sharedTags = [...new Set(
  related.flatMap(d => d.tags).filter(t => data.tags.includes(t))
)];
---

<Layout title={`${data.name} — Homelab`} description={data.headline}>

  <!-- ════════════════════════════════════════════════════════════
       HERO
  ════════════════════════════════════════════════════════════════ -->
  <HeroProduct
    name={data.name}
    headline={data.headline}
    role={data.role}
    status={data.status}
    type={data.type}
    location={data.location}
    services={data.services}
    photo={data.photos?.[0]}
    slug={entry.slug}
    eyebrowOverride={data.showcase?.heroEyebrow}
    tagline={data.showcase?.heroTagline}
  />

  <!-- ════════════════════════════════════════════════════════════
       BIG STATEMENT (from frontmatter showcase.bigStatement)
  ════════════════════════════════════════════════════════════════ -->
  {data.showcase?.bigStatement && (
    <BigStatement
      value={data.showcase.bigStatement.value}
      label={data.showcase.bigStatement.label}
      eyebrow={data.showcase.bigStatement.eyebrow}
      facts={data.showcase.bigStatement.facts}
    />
  )}

  <!-- ════════════════════════════════════════════════════════════
       UNIQUE MDX BODY
       Each device MDX file composes its own content here:
       custom graphic components, service sections, prose.
  ════════════════════════════════════════════════════════════════ -->
  <div class="device-body">
    <Content />
  </div>

  <!-- ════════════════════════════════════════════════════════════
       DECISIONS
  ════════════════════════════════════════════════════════════════ -->
  {hasDecisions && (
    <section class="py-20 section-divider" aria-labelledby="decisions-h">
      <div class="container-content">
        <Reveal class="mb-12 text-center">
          <p class="text-[0.7rem] font-semibold tracking-[0.12em] uppercase text-[var(--color-ink-4)] mb-3">
            Konfiguration &amp; Entscheidungen
          </p>
          <h2 id="decisions-h" class="text-display-sm text-[var(--color-ink-1)]">
            Was ich gewählt habe – und warum
          </h2>
        </Reveal>
        <FlagshipDecisions decisions={data.decisions} />
      </div>
    </section>
  )}

  <!-- ════════════════════════════════════════════════════════════
       SPECS TABLE
  ════════════════════════════════════════════════════════════════ -->
  <section id="specs" class="py-20 section-divider" aria-labelledby="specs-h">
    <div class="container-content">
      <Reveal class="mb-10 text-center">
        <p class="text-[0.7rem] font-semibold tracking-[0.12em] uppercase text-[var(--color-ink-4)] mb-3">
          Hardware
        </p>
        <h2 id="specs-h" class="text-display-sm text-[var(--color-ink-1)]">
          Technische Daten
        </h2>
      </Reveal>
      <Reveal delay={60}>
        <SpecsTable specs={data.specs} />
      </Reveal>
    </div>
  </section>

  <!-- ════════════════════════════════════════════════════════════
       GALLERY (only when > 1 photo)
  ════════════════════════════════════════════════════════════════ -->
  {data.photos.length > 1 && (
    <section class="py-16 section-divider" aria-labelledby="gallery-h">
      <div class="container-content">
        <Reveal class="mb-10 text-center">
          <p class="text-[0.7rem] font-semibold tracking-[0.12em] uppercase text-[var(--color-ink-4)] mb-3">
            Fotos
          </p>
          <h2 id="gallery-h" class="text-display-sm text-[var(--color-ink-1)]">
            Galerie
          </h2>
        </Reveal>
        <Reveal delay={60}>
          <Gallery photos={data.photos} name={data.name} />
        </Reveal>
      </div>
    </section>
  )}

  <!-- ════════════════════════════════════════════════════════════
       RELATED DEVICES
  ════════════════════════════════════════════════════════════════ -->
  {related.length > 0 && (
    <div class="section-divider py-16">
      <div class="container-content">
        <RelatedProducts
          devices={related}
          currentSlug={entry.slug}
          sharedTags={sharedTags}
        />
      </div>
    </div>
  )}

  <!-- ════════════════════════════════════════════════════════════
       PRODUCT CTA
  ════════════════════════════════════════════════════════════════ -->
  <section id="product" class="py-20 section-divider" aria-labelledby="product-h">
    <div class="container-content">
      <Reveal>
        <div class="rounded-[20px] bg-[var(--color-surface-1)] border border-[rgba(255,255,255,0.07)] p-10 md:p-14 text-center relative overflow-hidden">
          <div
            class="pointer-events-none absolute inset-0 opacity-[0.07]"
            style="background: radial-gradient(ellipse 60% 50% at 50% 100%, var(--color-accent), transparent);"
            aria-hidden="true"
          ></div>
          <div class="relative">
            <p class="text-[0.7rem] font-semibold tracking-[0.12em] uppercase text-[var(--color-ink-4)] mb-4">
              Offizielles Produkt
            </p>
            <h2
              id="product-h"
              class="text-display-sm text-[var(--color-ink-1)] mb-4 tracking-tight"
            >
              {data.name}
            </h2>
            <p class="text-[1rem] font-light text-[var(--color-ink-3)] max-w-[42ch] mx-auto leading-[1.65] mb-8">
              Offizielle Produktseite, technische Spezifikationen und Bezugsquellen.
            </p>
            <a
              href={data.productUrl}
              class="btn-primary-lg"
              target="_blank"
              rel="noopener noreferrer"
            >
              Zum Produkt ↗
            </a>
          </div>
        </div>
      </Reveal>
    </div>
  </section>

  <!-- ════════════════════════════════════════════════════════════
       BACK NAVIGATION
  ════════════════════════════════════════════════════════════════ -->
  <div class="py-12 text-center">
    <a href="/lineup" class="btn-secondary">← Zur Geräteübersicht</a>
  </div>

  <BackToTop />

</Layout>
