---
import { getCollection } from 'astro:content';

const allSoftware = await getCollection('software');
const allDevices  = await getCollection('devices');

const deviceNames: Record<string, string> = {};
for (const d of allDevices) deviceNames[d.id] = d.data.name;

type SoftwareEntry = {
  id:         string;
  title:      string;
  category:   string;
  summary:    string;
  tags:       string[];
  runsOn?:    string;
  deviceName: string;
};

const items: SoftwareEntry[] = allSoftware.map(e => ({
  id:         e.id,
  title:      e.data.title,
  category:   e.data.category,
  summary:    e.data.summary,
  tags:       e.data.tags,
  runsOn:     e.data.runsOn,
  deviceName: e.data.runsOn
    ? (deviceNames[e.data.runsOn] ?? e.data.deviceName ?? e.data.runsOn)
    : (e.data.deviceName ?? 'Cloud'),
}));

const groupMap = new Map<string, { deviceName: string; slug?: string; services: SoftwareEntry[] }>();

for (const item of items) {
  const key = item.runsOn ?? '__cloud__';
  if (!groupMap.has(key)) {
    groupMap.set(key, { deviceName: item.deviceName, slug: item.runsOn, services: [] });
  }
  groupMap.get(key)!.services.push(item);
}

const groups = [...groupMap.entries()]
  .sort(([a], [b]) => {
    if (a === '__cloud__') return 1;
    if (b === '__cloud__') return -1;
    return a.localeCompare(b);
  })
  .map(([key, val]) => ({ key, ...val }));

const categories = ['Media & Web', 'Infrastruktur', 'Home Automation', 'Organisation'] as const;
---

<div class="sm-root" data-sm>

  <!-- Sentinel: zero-height marker used by IntersectionObserver to detect sticky state -->
  <div class="sm-sentinel" aria-hidden="true"></div>

  <!-- Filter bar (sticky) -->
  <div class="sm-filters" data-sm-filters role="group" aria-label="Nach Kategorie filtern">
    <button class="sm-pill sm-pill--active" data-sm-filter="all" aria-pressed="true">Alle</button>
    {categories.map(cat => (
      <button class="sm-pill" data-sm-filter={cat} aria-pressed="false">{cat}</button>
    ))}
  </div>

  <!-- Device groups -->
  <div class="sm-groups" role="list">
    {groups.map((group, gi) => (
      <div
        class="sm-group"
        data-sm-group
        data-categories={[...new Set(group.services.map(s => s.category))].join(',')}
        role="listitem"
      >
        <!-- Header -->
        <button
          class="sm-header"
          data-sm-toggle
          aria-expanded={gi === 0 ? 'true' : 'false'}
          aria-controls={`sm-body-${gi}`}
          id={`sm-hdr-${gi}`}
        >
          <div class="sm-header-left">
            <span class="sm-dot" aria-hidden="true"></span>
            <div class="sm-header-text">
              {group.slug
                ? <a href={`/device/${group.slug}`} class="sm-device-name" onclick="event.stopPropagation()">{group.deviceName}</a>
                : <span class="sm-device-name sm-device-name--muted">{group.deviceName}</span>
              }
              <span class="sm-count">{group.services.length} {group.services.length === 1 ? 'Dienst' : 'Dienste'}</span>
            </div>
          </div>
          <svg class="sm-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <!-- Expandable body -->
        <div
          class:list={['sm-body', gi === 0 ? 'sm-body--open' : '']}
          id={`sm-body-${gi}`}
          role="region"
          aria-labelledby={`sm-hdr-${gi}`}
        >
          <ul class="sm-service-list" role="list">
            {group.services.map(svc => (
              <li class="sm-service" data-category={svc.category} role="listitem">
                <div class="sm-service-main">
                  <p class="sm-service-name-text">{svc.title}</p>
                  <p class="sm-service-desc">{svc.summary}</p>
                </div>
                <div class="sm-service-foot">
                  {svc.tags.length > 0 && (
                    <ul class="sm-tag-list" role="list" aria-label="Tags">
                      {svc.tags.map(t => <li class="sm-tag">{t}</li>)}
                    </ul>
                  )}
                  {svc.runsOn && (
                    <a href={`/device/${svc.runsOn}`} class="sm-service-link">Gerät →</a>
                  )}
                </div>
              </li>
            ))}
          </ul>
        </div>
      </div>
    ))}
  </div>

</div>

<script>
  document.querySelectorAll<HTMLElement>('[data-sm]').forEach(root => {
    const pills    = root.querySelectorAll<HTMLButtonElement>('[data-sm-filter]');
    const groups   = root.querySelectorAll<HTMLElement>('[data-sm-group]');
    const toggles  = root.querySelectorAll<HTMLButtonElement>('[data-sm-toggle]');
    const filtersEl = root.querySelector<HTMLElement>('[data-sm-filters]');
    const sentinel  = root.querySelector<HTMLElement>('.sm-sentinel');

    // ── Sticky glass ──────────────────────────────────────────
    if (sentinel && filtersEl) {
      const io = new IntersectionObserver(
        ([e]) => filtersEl.toggleAttribute('data-stuck', !e.isIntersecting),
        { rootMargin: '-57px 0px 0px 0px', threshold: 0 }
      );
      io.observe(sentinel);
    }

    // ── Filter ────────────────────────────────────────────────
    function applyFilter(filter: string) {
      pills.forEach(p => {
        const active = p.dataset.smFilter === filter;
        p.classList.toggle('sm-pill--active', active);
        p.setAttribute('aria-pressed', String(active));
      });
      groups.forEach(g => {
        const cats = (g.dataset.categories ?? '').split(',');
        const show = filter === 'all' || cats.includes(filter);
        g.style.display = show ? '' : 'none';
        g.querySelectorAll<HTMLElement>('[data-category]').forEach(svc => {
          svc.style.display = filter === 'all' || svc.dataset.category === filter ? '' : 'none';
        });
      });
    }

    pills.forEach(p => p.addEventListener('click', () => applyFilter(p.dataset.smFilter ?? 'all')));

    // ── Accordion — one open at a time ────────────────────────
    function setPanel(btn: HTMLButtonElement, open: boolean) {
      const bodyId = btn.getAttribute('aria-controls');
      const body   = bodyId ? root.querySelector<HTMLElement>(`#${bodyId}`) : null;
      if (!body) return;
      btn.setAttribute('aria-expanded', String(open));
      body.classList.toggle('sm-body--open', open);
    }

    toggles.forEach(btn => {
      btn.addEventListener('click', () => {
        const willOpen = btn.getAttribute('aria-expanded') !== 'true';
        toggles.forEach(other => other !== btn && setPanel(other, false));
        setPanel(btn, willOpen);
      });
    });
  });
</script>

<style>
  /* ── Root ───────────────────────────────────────────────────── */
  .sm-root { display: flex; flex-direction: column; }

  /* ── Sentinel ───────────────────────────────────────────────── */
  .sm-sentinel { height: 0; }

  /* ── Filter bar ─────────────────────────────────────────────── */
  .sm-filters {
    position: sticky;
    top: 56px;
    z-index: 20;
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    padding: 1rem 0 1.25rem;
    background: transparent;
    transition: background 220ms ease, box-shadow 220ms ease;
  }
  .sm-filters[data-stuck] {
    background: rgba(5, 7, 15, 0.85);
    backdrop-filter: blur(24px) saturate(1.6);
    -webkit-backdrop-filter: blur(24px) saturate(1.6);
    box-shadow: 0 1px 0 rgba(255, 255, 255, 0.05), 0 8px 32px rgba(0, 0, 0, 0.35);
  }

  /* ── Filter pills ───────────────────────────────────────────── */
  .sm-pill {
    padding: 0.35rem 1rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid rgba(255, 255, 255, 0.07);
    background: rgba(255, 255, 255, 0.025);
    color: var(--color-ink-3);
    white-space: nowrap;
    transition: background 160ms ease, color 160ms ease, border-color 160ms ease;
  }
  .sm-pill:hover {
    color: var(--color-ink-1);
    border-color: rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.05);
  }
  .sm-pill--active {
    background: rgba(79, 142, 247, 0.12);
    border-color: rgba(79, 142, 247, 0.25);
    color: var(--color-accent);
  }
  .sm-pill--active:hover { background: rgba(79, 142, 247, 0.17); }
  .sm-pill:focus-visible {
    outline: 2px solid rgba(79, 142, 247, 0.55);
    outline-offset: 2px;
  }

  /* ── Groups ─────────────────────────────────────────────────── */
  .sm-groups { display: flex; flex-direction: column; gap: 0.625rem; }

  .sm-group {
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    background: rgba(255, 255, 255, 0.018);
    backdrop-filter: blur(24px) saturate(1.3);
    -webkit-backdrop-filter: blur(24px) saturate(1.3);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.03);
    overflow: hidden;
    transition: border-color 220ms ease, box-shadow 220ms ease;
  }
  .sm-group:has([aria-expanded="true"]) {
    border-color: rgba(255, 255, 255, 0.085);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.22), inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  /* ── Header ─────────────────────────────────────────────────── */
  .sm-header {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1.125rem 1.375rem;
    background: transparent;
    border: none;
    cursor: pointer;
    text-align: left;
    transition: background 160ms ease;
  }
  .sm-header:hover  { background: rgba(255, 255, 255, 0.02); }
  .sm-header:focus-visible {
    outline: 2px solid rgba(79, 142, 247, 0.5);
    outline-offset: -2px;
    border-radius: 14px;
  }

  .sm-header-left {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    min-width: 0;
  }

  /* ── Status dot ─────────────────────────────────────────────── */
  .sm-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
    background: rgba(79, 142, 247, 0.55);
    box-shadow: 0 0 6px rgba(79, 142, 247, 0.22);
  }

  .sm-header-text {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    min-width: 0;
  }

  .sm-device-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-ink-1);
    letter-spacing: -0.015em;
    line-height: 1.25;
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 160ms ease;
  }
  .sm-device-name--muted { color: var(--color-ink-2); }
  a.sm-device-name:hover { color: var(--color-accent); }

  .sm-count {
    font-size: 0.68rem;
    color: var(--color-ink-4);
    letter-spacing: 0.01em;
  }

  /* ── Chevron ────────────────────────────────────────────────── */
  .sm-chevron {
    color: var(--color-ink-4);
    flex-shrink: 0;
    transition: transform 260ms cubic-bezier(0.16, 1, 0.3, 1), color 160ms ease;
  }
  [aria-expanded="true"] .sm-chevron {
    transform: rotate(180deg);
    color: var(--color-ink-2);
  }

  /* ── Body expand / collapse ─────────────────────────────────── */
  .sm-body {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 280ms cubic-bezier(0.16, 1, 0.3, 1);
  }
  .sm-body--open { grid-template-rows: 1fr; }

  .sm-body > .sm-service-list {
    overflow: hidden;
    list-style: none;
    margin: 0;
    padding: 0;
  }
  .sm-body--open > .sm-service-list {
    border-top: 1px solid rgba(255, 255, 255, 0.045);
    padding-bottom: 0.375rem;
  }

  /* ── Service rows ───────────────────────────────────────────── */
  .sm-service {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    padding: 0.875rem 1.375rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.032);
    transition: background 140ms ease;
  }
  .sm-service:last-child { border-bottom: none; }
  .sm-service:hover      { background: rgba(255, 255, 255, 0.016); }

  .sm-service-main { display: flex; flex-direction: column; gap: 0.2rem; }

  .sm-service-name-text {
    font-size: 0.84rem;
    font-weight: 600;
    color: var(--color-ink-1);
    letter-spacing: -0.01em;
    line-height: 1.25;
  }

  .sm-service-desc {
    font-size: 0.775rem;
    color: var(--color-ink-3);
    line-height: 1.55;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* ── Service footer ─────────────────────────────────────────── */
  .sm-service-foot {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: 0.15rem;
  }

  .sm-tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.22rem;
    list-style: none;
    margin: 0;
    padding: 0;
    flex: 1;
    min-width: 0;
  }
  .sm-tag {
    font-size: 0.62rem;
    font-weight: 500;
    color: var(--color-ink-4);
    background: rgba(255, 255, 255, 0.028);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 9999px;
    padding: 0.1rem 0.45rem;
    white-space: nowrap;
  }

  .sm-service-link {
    font-size: 0.71rem;
    color: var(--color-ink-4);
    text-decoration: none;
    white-space: nowrap;
    flex-shrink: 0;
    margin-left: auto;
    transition: color 140ms ease;
  }
  .sm-service-link:hover { color: var(--color-accent); }
  .sm-service-link:focus-visible {
    outline: 2px solid rgba(79, 142, 247, 0.5);
    outline-offset: 2px;
    border-radius: 3px;
  }

  /* ── Reduced motion ─────────────────────────────────────────── */
  @media (prefers-reduced-motion: reduce) {
    .sm-body, .sm-chevron, .sm-pill, .sm-header,
    .sm-group, .sm-filters, .sm-service, .sm-service-link { transition: none; }
  }
</style>
