---
/**
 * StorageViz.astro — QNAP NAS RAID-5 storage visualization.
 * Shows the 4-drive array with health LEDs + animated storage allocation bars.
 */

const drives = [
  { slot: 1, model: 'WD Red Plus',  size: '4 TB',  healthy: true  },
  { slot: 2, model: 'WD Red Plus',  size: '4 TB',  healthy: true  },
  { slot: 3, model: 'WD Red Plus',  size: '4 TB',  healthy: true  },
  { slot: 4, model: 'WD Red Plus',  size: '4 TB',  healthy: true  },
];

const allocation = [
  { label: 'Medien',       size: '3.8 TB', pct: 48,  color: '#4f8ef7', delay: '0.1s' },
  { label: 'Backups',      size: '1.6 TB', pct: 20,  color: '#34d399', delay: '0.3s' },
  { label: 'Dokumente',    size: '0.4 TB', pct:  5,  color: '#f59e0b', delay: '0.5s' },
  { label: 'Fotos',        size: '0.2 TB', pct:  3,  color: '#a855f7', delay: '0.7s' },
  { label: 'Frei',         size: '2.0 TB', pct: 24,  color: '#2b3248', delay: '0.9s' },
];
---

<div class="sv-wrap">

  <!-- ── RAID Array ── -->
  <div class="sv-array-section">
    <div class="sv-array-header">
      <span class="sv-array-label">RAID-5 Array</span>
      <span class="sv-array-badge">
        <span class="sv-health-dot"></span>
        Healthy — 4 Drives
      </span>
    </div>

    <div class="sv-drives">
      {drives.map(d => (
        <div class="sv-drive">
          <!-- Drive bay outline -->
          <div class="sv-bay">
            <!-- Stacked platters icon -->
            <div class="sv-bay-icon">
              <div class="sv-platter"></div>
              <div class="sv-platter"></div>
              <div class="sv-platter"></div>
            </div>
            <!-- Status LED -->
            <div class={`sv-led ${d.healthy ? 'sv-led--ok' : 'sv-led--err'}`}></div>
          </div>
          <div class="sv-drive-meta">
            <span class="sv-drive-slot">Slot {d.slot}</span>
            <span class="sv-drive-size">{d.size}</span>
          </div>
          <div class="sv-drive-model">{d.model}</div>
        </div>
      ))}

      <!-- Parity indicator -->
      <div class="sv-parity">
        <div class="sv-parity-icon">P</div>
        <div class="sv-drive-meta">
          <span class="sv-drive-slot">Parity</span>
          <span class="sv-drive-size">4 TB</span>
        </div>
        <div class="sv-drive-model">Distributed</div>
      </div>
    </div>

    <!-- Capacity summary bar -->
    <div class="sv-cap-bar">
      {allocation.map(a => (
        <div
          class="sv-cap-seg"
          style={`
            background: ${a.color};
            width: ${a.pct}%;
            opacity: ${a.label === 'Frei' ? 0.12 : 0.75};
          `}
          title={`${a.label}: ${a.size}`}
        ></div>
      ))}
    </div>
    <div class="sv-cap-legend">
      {allocation.filter(a => a.label !== 'Frei').map(a => (
        <span class="sv-cap-item">
          <span class="sv-cap-dot" style={`background: ${a.color}`}></span>
          {a.label}
        </span>
      ))}
      <span class="sv-cap-total">6.0 / 8.0 TB</span>
    </div>
  </div>

  <!-- ── Allocation Breakdown ── -->
  <div class="sv-alloc-section">
    <div class="sv-alloc-chrome">
      <span class="sv-chrome-dot" style="background:#ff5f57"></span>
      <span class="sv-chrome-dot" style="background:#febc2e"></span>
      <span class="sv-chrome-dot" style="background:#28c840"></span>
      <span class="sv-chrome-title">Speicherübersicht · QTS Storage Manager</span>
      <span class="sv-chrome-total">8.0 TB</span>
    </div>

    <div class="sv-alloc-rows">
      {allocation.filter(a => a.label !== 'Frei').map(a => (
        <div class="sv-alloc-row">
          <span class="sv-alloc-label">{a.label}</span>
          <div class="sv-alloc-track">
            <div
              class="sv-alloc-fill"
              style={`--pct: ${a.pct}%; --clr: ${a.color}; animation-delay: ${a.delay}`}
            ></div>
          </div>
          <span class="sv-alloc-size">{a.size}</span>
        </div>
      ))}

      <!-- Free space row -->
      <div class="sv-alloc-row sv-alloc-row--free">
        <span class="sv-alloc-label">Verfügbar</span>
        <div class="sv-alloc-track">
          <div
            class="sv-alloc-fill sv-alloc-fill--free"
            style="--pct: 24%; --clr: rgba(255,255,255,0.1); animation-delay: 1.1s"
          ></div>
        </div>
        <span class="sv-alloc-size sv-alloc-free-val">2.0 TB</span>
      </div>
    </div>

    <div class="sv-alloc-footer">
      <span class="sv-footer-item">RAID-5 · 4-Drive Array</span>
      <span class="sv-footer-dot"></span>
      <span class="sv-footer-item sv-footer-healthy">● Healthy</span>
      <span class="sv-footer-dot"></span>
      <span class="sv-footer-item">Gigabit Ethernet</span>
    </div>
  </div>

</div>

<style>
  .sv-wrap {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.25rem;
    width: 100%;
  }
  @media (min-width: 860px) {
    .sv-wrap { grid-template-columns: 1fr 1fr; align-items: start; }
  }

  /* ── Array section ── */
  .sv-array-section {
    background: var(--color-surface-1);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 14px;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .sv-array-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }
  .sv-array-label {
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--color-ink-3);
  }
  .sv-array-badge {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.7rem;
    color: #22c55e;
    font-weight: 500;
  }
  .sv-health-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: #22c55e;
    animation: sv-blink 2s ease-in-out infinite;
  }
  @keyframes sv-blink {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.35; }
  }

  /* Drive slots */
  .sv-drives {
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
  }

  .sv-drive, .sv-parity {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
  }

  .sv-bay {
    width: 100%;
    aspect-ratio: 1 / 1.4;
    max-height: 72px;
    background: var(--color-surface-2);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 7px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    position: relative;
  }

  /* Hard-drive platter layers */
  .sv-bay-icon { display: flex; flex-direction: column; gap: 2px; }
  .sv-platter {
    width: 22px; height: 3px;
    background: rgba(79,142,247,0.3);
    border-radius: 2px;
  }

  .sv-led {
    position: absolute;
    top: 5px; right: 5px;
    width: 5px; height: 5px;
    border-radius: 50%;
  }
  .sv-led--ok  { background: #22c55e; animation: sv-blink 2.5s ease-in-out infinite; }
  .sv-led--err { background: #ef4444; }

  .sv-drive-meta {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
  }
  .sv-drive-slot  { font-size: 0.6rem; color: var(--color-ink-4); letter-spacing: 0.04em; }
  .sv-drive-size  { font-size: 0.7rem; color: var(--color-ink-2); font-weight: 600; }
  .sv-drive-model { font-size: 0.55rem; color: var(--color-ink-4); text-align: center; white-space: nowrap; }

  /* Parity column */
  .sv-parity .sv-bay {
    border-style: dashed;
    border-color: rgba(79,142,247,0.2);
    background: rgba(79,142,247,0.04);
  }
  .sv-parity-icon {
    font-size: 1rem;
    font-weight: 800;
    color: rgba(79,142,247,0.5);
    font-family: system-ui, sans-serif;
  }

  /* Capacity bar */
  .sv-cap-bar {
    display: flex;
    height: 6px;
    border-radius: 4px;
    overflow: hidden;
    gap: 1px;
  }
  .sv-cap-seg { height: 100%; transition: width 1.2s cubic-bezier(0.16,1,0.3,1); }

  .sv-cap-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }
  .sv-cap-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.65rem;
    color: var(--color-ink-3);
  }
  .sv-cap-dot { width: 6px; height: 6px; border-radius: 50%; }
  .sv-cap-total {
    margin-left: auto;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--color-ink-2);
    font-variant-numeric: tabular-nums;
  }

  /* ── Allocation section ── */
  .sv-alloc-section {
    background: var(--color-surface-1);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 14px;
    overflow: hidden;
    font-family: 'SF Mono','Fira Code',ui-monospace,monospace;
    font-size: 0.72rem;
  }

  .sv-alloc-chrome {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 10px 14px;
    background: var(--color-surface-2);
    border-bottom: 1px solid rgba(255,255,255,0.055);
  }
  .sv-chrome-dot  { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .sv-chrome-title {
    flex: 1;
    font-size: 0.66rem;
    color: var(--color-ink-3);
    margin-left: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .sv-chrome-total { font-size: 0.65rem; color: var(--color-ink-2); font-weight: 600; }

  .sv-alloc-rows {
    display: flex;
    flex-direction: column;
    padding: 10px 14px;
    gap: 0;
  }
  .sv-alloc-row {
    display: grid;
    grid-template-columns: 76px 1fr 52px;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }
  .sv-alloc-row:last-child { border-bottom: none; }
  .sv-alloc-row--free { opacity: 0.6; }

  .sv-alloc-label { font-size: 0.65rem; color: var(--color-ink-3); }
  .sv-alloc-track {
    height: 5px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px;
    overflow: hidden;
  }
  .sv-alloc-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--clr);
    width: 0;
    animation: sv-grow 1.4s cubic-bezier(0.16,1,0.3,1) forwards;
    animation-delay: var(--delay, 0s);
  }
  @keyframes sv-grow {
    from { width: 0; }
    to   { width: var(--pct); }
  }
  .sv-alloc-size { font-size: 0.62rem; color: var(--color-ink-4); text-align: right; }
  .sv-alloc-free-val { color: var(--color-ink-4); }

  .sv-alloc-footer {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 9px 14px;
    border-top: 1px solid rgba(255,255,255,0.055);
    background: rgba(255,255,255,0.016);
  }
  .sv-footer-item { font-size: 0.6rem; color: var(--color-ink-4); }
  .sv-footer-dot  { width: 3px; height: 3px; background: var(--color-ink-4); border-radius: 50%; }
  .sv-footer-healthy { color: #22c55e; }

  @media (prefers-reduced-motion: reduce) {
    .sv-health-dot, .sv-led--ok { animation: none; }
    .sv-alloc-fill { animation: none; width: var(--pct); }
  }
</style>
