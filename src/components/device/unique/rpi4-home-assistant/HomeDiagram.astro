---
/**
 * HomeDiagram.astro — Raspberry Pi 4 / Home Assistant IoT diagram.
 * Abstract floor-plan style layout with device nodes and Zigbee connections.
 */

const devices = [
  { id: 'ha',      label: 'Home Assistant', x: 280, y: 160, color: '#4f8ef7', size: 36, primary: true },
  { id: 'zigbee',  label: 'Zigbee2MQTT',    x: 280, y: 160, color: '#4f8ef7', size: 0,  primary: false }, // virtual — same center
  { id: 'light1',  label: 'Licht',          x: 100, y: 60,  color: '#f59e0b', size: 22, primary: false },
  { id: 'light2',  label: 'Licht',          x: 460, y: 60,  color: '#f59e0b', size: 22, primary: false },
  { id: 'thermos', label: 'Thermostat',     x: 100, y: 260, color: '#34d399', size: 22, primary: false },
  { id: 'water',   label: 'Wassersensor',   x: 460, y: 260, color: '#ef4444', size: 22, primary: false },
  { id: 'door',    label: 'Türsensor',      x: 280, y: 310, color: '#a855f7', size: 22, primary: false },
  { id: 'esp',     label: 'ESPHome',        x: 160, y: 165, color: '#64748b', size: 18, primary: false },
  { id: 'mqtt',    label: 'MQTT',           x: 400, y: 165, color: '#64748b', size: 18, primary: false },
];

// lines from center (HA) to each peripheral device
const lines = [
  { from: [280,160], to: [100, 60]  },
  { from: [280,160], to: [460, 60]  },
  { from: [280,160], to: [100, 260] },
  { from: [280,160], to: [460, 260] },
  { from: [280,160], to: [280, 310] },
  { from: [280,160], to: [160, 165] },
  { from: [280,160], to: [400, 165] },
];
---

<div class="hd-wrapper">
  <div class="hd-eyebrow">Heimautomatisierung · Lokal · Ohne Cloud</div>
  <svg
    viewBox="0 0 560 380"
    class="hd-svg"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
    role="img"
    aria-label="Home Assistant Gerätediagramm"
  >
    <!-- Connection lines -->
    {lines.map((l, i) => (
      <line
        class="hd-line"
        x1={l.from[0]} y1={l.from[1]}
        x2={l.to[0]}   y2={l.to[1]}
        style={`animation-delay: ${i * 0.15}s`}
      />
    ))}

    <!-- Animated pulse rings on center -->
    <circle cx="280" cy="160" r="52" class="hd-ring hd-ring-1" />
    <circle cx="280" cy="160" r="68" class="hd-ring hd-ring-2" />

    <!-- Center node — Home Assistant -->
    <circle cx="280" cy="160" r="36" class="hd-center" />
    <text x="280" y="156" class="hd-center-label" text-anchor="middle">HA</text>
    <text x="280" y="170" class="hd-center-sub" text-anchor="middle">local</text>

    <!-- Peripheral nodes -->
    {devices.filter(d => !d.primary && d.size > 0).map(dev => (
      <>
        <circle cx={dev.x} cy={dev.y} r={dev.size} class="hd-node" style={`--node-color: ${dev.color}`} />
        <text x={dev.x} y={dev.y + dev.size + 12} class="hd-node-label" text-anchor="middle">
          {dev.label}
        </text>
      </>
    ))}

    <!-- Animated travel dots -->
    {lines.map((l, i) => (
      <circle class="hd-traveler" r="3" cx="0" cy="0"
        style={`animation-delay: ${i * 0.4}s`}>
        <animateMotion
          dur={`${2.5 + i * 0.3}s`}
          repeatCount="indefinite"
          begin={`${i * 0.4}s`}
          calcMode="spline"
          keySplines="0.4 0 0.6 1"
          keyTimes="0;1"
          path={`M ${l.from[0]} ${l.from[1]} L ${l.to[0]} ${l.to[1]}`}
        />
      </circle>
    ))}
  </svg>
</div>

<style>
  .hd-wrapper {
    width: 100%;
    max-width: 560px;
    margin: 0 auto;
  }
  .hd-eyebrow {
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--color-ink-4);
    text-align: center;
    margin-bottom: 0.75rem;
  }
  .hd-svg {
    width: 100%;
    height: auto;
    overflow: visible;
  }

  .hd-line {
    stroke: rgba(79,142,247,0.15);
    stroke-width: 1.5;
    stroke-dasharray: 4 3;
  }

  .hd-ring {
    fill: none;
    stroke: rgba(79,142,247,0.12);
    stroke-width: 1;
    animation: hd-pulse 3s ease-in-out infinite;
  }
  .hd-ring-2 { animation-delay: 1s; }
  @keyframes hd-pulse {
    0%, 100% { opacity: 0.5; transform-origin: 280px 160px; transform: scale(1); }
    50%       { opacity: 0.1; transform-origin: 280px 160px; transform: scale(1.06); }
  }

  .hd-center {
    fill: rgba(79,142,247,0.15);
    stroke: rgba(79,142,247,0.5);
    stroke-width: 1.5;
  }
  .hd-center-label {
    fill: #eef0f8;
    font-size: 13px;
    font-weight: 700;
    font-family: system-ui, sans-serif;
    dominant-baseline: middle;
  }
  .hd-center-sub {
    fill: #7e8baa;
    font-size: 9px;
    font-family: system-ui, sans-serif;
    letter-spacing: 0.05em;
    dominant-baseline: middle;
  }

  .hd-node {
    fill: color-mix(in srgb, var(--node-color) 12%, transparent);
    stroke: color-mix(in srgb, var(--node-color) 45%, transparent);
    stroke-width: 1.5;
  }
  .hd-node-label {
    fill: #7e8baa;
    font-size: 10px;
    font-family: system-ui, sans-serif;
    dominant-baseline: middle;
  }

  .hd-traveler {
    fill: rgba(79,142,247,0.8);
  }

  @media (prefers-reduced-motion: reduce) {
    .hd-ring { animation: none; }
  }
</style>
