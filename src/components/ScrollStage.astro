---
import DashboardPreview from './previews/DashboardPreview.astro';
import TerminalPreview  from './previews/TerminalPreview.astro';
import PlexPreview      from './previews/PlexPreview.astro';
import BackupPreview    from './previews/BackupPreview.astro';
import TraefikPreview   from './previews/TraefikPreview.astro';

type Scene = 'dashboard' | 'terminal' | 'plex' | 'backup' | 'traefik' | 'generic';

interface Feature {
  title:       string;
  description: string;
  scene:       Scene;
}

interface Props {
  features:   Feature[];
  sectionLabel?: string;
}

const { features, sectionLabel = 'Feature deep dive' } = Astro.props;

// Height = (N+1) × 100vh → N feature panels + 1 viewport for entry
const scrollHeight = `${(features.length + 1) * 100}vh`;
---

{features.length > 0 && (

  <section aria-label={sectionLabel} data-scroll-stage-section>

    <!-- ── MOBILE: stacked list (no scroll stage) ─────────────────── -->
    <div class="block lg:hidden px-6 py-16 space-y-16">
      {features.map((f, i) => (
        <div class="flex gap-5 reveal">
          <span class="flex-shrink-0 text-[2.5rem] font-black tabular-nums leading-none text-[var(--color-surface-4)] pt-1">
            {String(i + 1).padStart(2, '0')}
          </span>
          <div>
            <h3 class="text-[1.25rem] font-bold tracking-[-0.02em] text-[var(--color-ink-1)] mb-2">
              {f.title}
            </h3>
            <p class="text-[0.9375rem] leading-[1.65] text-[var(--color-ink-3)] mb-6">
              {f.description}
            </p>
            <!-- Inline preview on mobile -->
            <div class="rounded-[14px] overflow-hidden border border-[rgba(255,255,255,0.065)]">
              {f.scene === 'dashboard' && <DashboardPreview />}
              {f.scene === 'terminal'  && <TerminalPreview  />}
              {f.scene === 'plex'      && <PlexPreview      />}
              {f.scene === 'backup'    && <BackupPreview    />}
              {f.scene === 'traefik'   && <TraefikPreview   />}
              {f.scene === 'generic'   && (
                <div class="media-placeholder aspect-[4/3] flex items-center justify-center">
                  <svg width="48" height="48" viewBox="0 0 72 72" fill="none" aria-hidden="true" class="opacity-20">
                    <rect x="4"  y="4"  width="28" height="28" rx="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                    <rect x="40" y="4"  width="28" height="28" rx="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                    <rect x="4"  y="40" width="28" height="28" rx="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                    <rect x="40" y="40" width="28" height="28" rx="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  </svg>
                </div>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- ── DESKTOP: sticky scroll stage ──────────────────────────── -->
    <div
      data-scroll-stage
      class="hidden lg:block relative"
      style={`height: ${scrollHeight}`}
    >
      <!-- Sticky viewport -->
      <div data-stage-inner class="sticky top-0 h-screen overflow-hidden flex items-center">

        <div class="w-full max-w-[1280px] mx-auto px-12 grid grid-cols-[1fr_480px] gap-12 items-center">

          <!-- Left: numbered step list -->
          <div class="flex flex-col gap-10 py-12">
            {features.map((f, i) => (
              <div
                data-step={i}
                class="ss-step flex gap-6 cursor-default"
              >
                <!-- Number -->
                <div class="flex-shrink-0 pt-1 w-16 text-right">
                  <span class="ss-step-num text-[3rem] font-black tabular-nums leading-none select-none">
                    {String(i + 1).padStart(2, '0')}
                  </span>
                </div>
                <!-- Text -->
                <div class="flex-1 min-w-0">
                  <h3 class="ss-step-title text-[1.5rem] font-bold tracking-[-0.02em] mb-2 leading-[1.2]">
                    {f.title}
                  </h3>
                  <p class="ss-step-desc text-[0.9375rem] leading-[1.65] max-w-[36ch]">
                    {f.description}
                  </p>
                </div>
              </div>
            ))}
          </div>

          <!-- Right: scene stage -->
          <div class="relative ss-stage-wrap">
            {features.map((f, i) => (
              <div
                data-scene={i}
                class="ss-scene"
                style={i === 0 ? 'opacity:1;transform:none;pointer-events:auto;' : ''}
              >
                {f.scene === 'dashboard' && <DashboardPreview />}
                {f.scene === 'terminal'  && <TerminalPreview  />}
                {f.scene === 'plex'      && <PlexPreview      />}
                {f.scene === 'backup'    && <BackupPreview    />}
                {f.scene === 'traefik'   && <TraefikPreview   />}
                {f.scene === 'generic'   && (
                  <div class="media-placeholder aspect-[4/3] rounded-[16px] w-full flex items-center justify-center">
                    <svg width="64" height="64" viewBox="0 0 72 72" fill="none" aria-hidden="true" class="opacity-20">
                      <rect x="4"  y="4"  width="28" height="28" rx="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                      <rect x="40" y="4"  width="28" height="28" rx="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                      <rect x="4"  y="40" width="28" height="28" rx="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                      <rect x="40" y="40" width="28" height="28" rx="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                  </div>
                )}
              </div>
            ))}
          </div>

        </div>
      </div>
    </div>

  </section>
)}

<script>
// ─── Scroll Stage — sticky scroll-driven feature transitions ─────────────
const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

document.querySelectorAll<HTMLElement>('[data-scroll-stage]').forEach(stage => {
  const steps  = stage.querySelectorAll<HTMLElement>('[data-step]');
  const scenes = stage.querySelectorAll<HTMLElement>('[data-scene]');
  const total  = steps.length;
  if (!total) return;

  // If reduced motion: show all active immediately
  if (prefersReduced) {
    steps.forEach(s  => activateStep(s, true));
    scenes.forEach(s => activateScene(s, true));
    return;
  }

  let currentIdx = 0;

  function activateStep(el: HTMLElement, active: boolean) {
    const num   = el.querySelector<HTMLElement>('.ss-step-num');
    const title = el.querySelector<HTMLElement>('.ss-step-title');
    const desc  = el.querySelector<HTMLElement>('.ss-step-desc');
    if (active) {
      el.style.opacity = '1';
      el.style.transform = 'none';
      if (num)   num.style.color   = 'var(--color-ink-1)';
      if (title) title.style.color = 'var(--color-ink-1)';
      if (desc)  desc.style.color  = 'var(--color-ink-2)';
    } else {
      el.style.opacity = '0.28';
      el.style.transform = 'none';
      if (num)   num.style.color   = 'var(--color-surface-4)';
      if (title) title.style.color = 'var(--color-ink-4)';
      if (desc)  desc.style.color  = 'var(--color-ink-4)';
    }
  }

  function activateScene(el: HTMLElement, active: boolean) {
    el.style.opacity        = active ? '1' : '0';
    el.style.transform      = active ? 'none' : 'translateY(10px)';
    el.style.pointerEvents  = active ? 'auto' : 'none';
  }

  // Initialize all inactive
  steps.forEach( (s, i) => activateStep(s, i === 0));
  scenes.forEach((s, i) => activateScene(s, i === 0));

  function update() {
    const rect      = stage.getBoundingClientRect();
    const scrolled  = -rect.top;
    const range     = stage.offsetHeight - window.innerHeight;
    if (range <= 0) return;

    const progress  = Math.max(0, Math.min(1, scrolled / range));
    const rawIdx    = progress * total;
    const idx       = Math.min(Math.floor(rawIdx), total - 1);

    if (idx === currentIdx) return;
    currentIdx = idx;

    steps.forEach( (s, i) => activateStep(s, i === idx));
    scenes.forEach((s, i) => activateScene(s, i === idx));
  }

  window.addEventListener('scroll', update, { passive: true });
  update();
});
</script>

<style>
  /* Step transitions */
  .ss-step {
    transition:
      opacity   500ms cubic-bezier(0.16, 1, 0.3, 1),
      transform 500ms cubic-bezier(0.16, 1, 0.3, 1);
  }
  .ss-step-num,
  .ss-step-title,
  .ss-step-desc {
    transition: color 450ms cubic-bezier(0.16, 1, 0.3, 1);
  }
  .ss-step-num   { color: var(--color-surface-4); }
  .ss-step-title { color: var(--color-ink-4); }
  .ss-step-desc  { color: var(--color-ink-4); }

  /* Stage wrap */
  .ss-stage-wrap {
    position: relative;
    height: 420px;
  }

  /* Scene positioning + transition */
  .ss-scene {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    transition:
      opacity   500ms cubic-bezier(0.16, 1, 0.3, 1),
      transform 500ms cubic-bezier(0.16, 1, 0.3, 1);
  }
  .ss-scene > * { width: 100%; }
</style>
