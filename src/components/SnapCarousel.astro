---
import MediaStage from './MediaStage.astro';

interface Item {
  label:    string;
  headline: string;
  body:     string;
  media?:   string;
}

interface Props {
  items: Item[];
  id?: string;
}

const { items, id = `carousel-${Math.random().toString(36).slice(2, 7)}` } = Astro.props;
---

<div class="snap-carousel-wrap relative" data-carousel-id={id}>

  <!-- Scroll container -->
  <div
    class="snap-carousel flex overflow-x-auto gap-4 pb-1"
    data-carousel-track
    role="region"
    aria-label="Funktions-Karussell"
    style="scroll-snap-type: x mandatory; scrollbar-width: none; -webkit-overflow-scrolling: touch;"
  >
    {items.map((item, i) => (
      <div
        class="snap-carousel-slide flex-shrink-0 w-[min(480px,85vw)] rounded-[16px] border border-[rgba(255,255,255,0.065)] bg-[var(--color-surface-1)] overflow-hidden"
        style="scroll-snap-align: start;"
        aria-label={item.label}
        data-slide={i}
      >
        <!-- Media -->
        <MediaStage src={item.media} alt={item.headline} aspect="aspect-video" class="rounded-b-none" />

        <!-- Copy -->
        <div class="p-6">
          <p class="text-[0.7rem] font-semibold tracking-[0.12em] uppercase text-[var(--color-ink-4)] mb-2">
            {item.label}
          </p>
          <h3 class="text-[1.1rem] font-semibold tracking-[-0.02em] text-[var(--color-ink-1)] mb-3 leading-[1.3]">
            {item.headline}
          </h3>
          <p class="text-[0.875rem] leading-[1.6] text-[var(--color-ink-3)]">
            {item.body}
          </p>
        </div>
      </div>
    ))}
  </div>

  <!-- Controls row -->
  <div class="flex items-center justify-between mt-5">

    <!-- Dot indicators -->
    <div class="flex items-center gap-2" role="tablist" aria-label="Karussell-Position">
      {items.map((_, i) => (
        <button
          role="tab"
          aria-selected={i === 0 ? 'true' : 'false'}
          aria-label={`Folie ${i + 1}`}
          data-carousel-dot={i}
          class:list={[
            'rounded-full transition-all duration-300',
            i === 0
              ? 'w-5 h-1.5 bg-[var(--color-accent)]'
              : 'w-1.5 h-1.5 bg-[rgba(255,255,255,0.2)]',
          ]}
        ></button>
      ))}
    </div>

    <!-- Prev / Next -->
    <div class="flex items-center gap-2">
      <button
        data-carousel-prev
        class="w-8 h-8 rounded-full border border-[rgba(255,255,255,0.09)] bg-[var(--color-surface-2)] flex items-center justify-center text-[var(--color-ink-3)] hover:text-[var(--color-ink-1)] hover:border-[rgba(255,255,255,0.14)] transition-all duration-200 disabled:opacity-30"
        aria-label="Vorherige Folie"
        disabled
      >
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
          <path d="M9 2L4.5 7 9 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button
        data-carousel-next
        class="w-8 h-8 rounded-full border border-[rgba(255,255,255,0.09)] bg-[var(--color-surface-2)] flex items-center justify-center text-[var(--color-ink-3)] hover:text-[var(--color-ink-1)] hover:border-[rgba(255,255,255,0.14)] transition-all duration-200 disabled:opacity-30"
        aria-label="NÃ¤chste Folie"
      >
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
          <path d="M5 2l4.5 5L5 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
document.querySelectorAll<HTMLElement>('[data-carousel-id]').forEach(wrap => {
  const track  = wrap.querySelector<HTMLElement>('[data-carousel-track]')!;
  const dots   = wrap.querySelectorAll<HTMLButtonElement>('[data-carousel-dot]');
  const prev   = wrap.querySelector<HTMLButtonElement>('[data-carousel-prev]')!;
  const next   = wrap.querySelector<HTMLButtonElement>('[data-carousel-next]')!;
  const slides = wrap.querySelectorAll<HTMLElement>('[data-slide]');
  const total  = slides.length;

  if (!track || total === 0) return;

  let current = 0;

  function setActive(idx: number) {
    current = Math.max(0, Math.min(idx, total - 1));

    // Scroll to slide
    const slide = slides[current];
    track.scrollTo({ left: (slide as HTMLElement).offsetLeft, behavior: 'smooth' });

    // Update dots
    dots.forEach((dot, i) => {
      const active = i === current;
      dot.setAttribute('aria-selected', String(active));
      dot.classList.toggle('w-5', active);
      dot.classList.toggle('bg-[var(--color-accent)]', active);
      dot.classList.toggle('w-1.5', !active);
      dot.classList.toggle('bg-[rgba(255,255,255,0.2)]', !active);
    });

    prev.disabled = current === 0;
    next.disabled = current === total - 1;
  }

  prev.addEventListener('click', () => setActive(current - 1));
  next.addEventListener('click', () => setActive(current + 1));
  dots.forEach((dot, i) => dot.addEventListener('click', () => setActive(i)));

  // Sync dots on scroll (snap)
  const io = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const idx = parseInt((e.target as HTMLElement).dataset.slide ?? '0', 10);
        if (idx !== current) setActive(idx);
      }
    });
  }, { root: track, threshold: 0.6 });

  slides.forEach(s => io.observe(s));
});
</script>

<style>
  .snap-carousel::-webkit-scrollbar { display: none; }
  .snap-carousel-slide { scroll-snap-align: start; }
</style>
