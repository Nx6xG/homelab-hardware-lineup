---
interface Props {
  photos: string[];
  name: string;
  class?: string;
}

const { photos, name, class: className = '' } = Astro.props;
---

{photos.length > 0 && (
  <div class:list={['gallery-root', className]}>
    <!-- Grid -->
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
      {photos.map((src, i) => (
        <button
          class="gallery-thumb group aspect-video rounded-xl overflow-hidden cursor-pointer border border-[rgba(255,255,255,0.07)] focus-visible:ring-2 focus-visible:ring-accent"
          data-src={src}
          data-index={i}
          aria-label={`Foto ${i + 1} von ${photos.length} — ${name}`}
        >
          <img
            src={src}
            alt={`${name} — Foto ${i + 1}`}
            class="w-full h-full object-cover transition-transform duration-500 cubic-bezier(0.22,1,0.36,1) group-hover:scale-105"
            loading="lazy"
            decoding="async"
          />
        </button>
      ))}
    </div>

    <!-- Lightbox -->
    <div
      id="lightbox"
      class="fixed inset-0 z-[200] hidden items-center justify-center bg-surface-0/95 backdrop-blur-xl"
      role="dialog"
      aria-modal="true"
      aria-label={`Fotogalerie — ${name}`}
    >
      <!-- Close -->
      <button
        id="lightbox-close"
        class="absolute top-5 right-5 w-10 h-10 rounded-full bg-surface-3 border border-[rgba(255,255,255,0.1)] flex items-center justify-center text-ink-2 hover:text-ink-1 hover:bg-surface-4 transition-colors"
        aria-label="Galerie schließen (Escape)"
      >
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M2 2l12 12M14 2L2 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <!-- Prev / Next -->
      <button
        id="lightbox-prev"
        class="absolute left-4 sm:left-8 w-11 h-11 rounded-full bg-surface-3 border border-[rgba(255,255,255,0.1)] flex items-center justify-center text-ink-2 hover:text-ink-1 hover:bg-surface-4 transition-colors"
        aria-label="Vorheriges Foto"
      >
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
          <path d="M11 3L5 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button
        id="lightbox-next"
        class="absolute right-4 sm:right-8 w-11 h-11 rounded-full bg-surface-3 border border-[rgba(255,255,255,0.1)] flex items-center justify-center text-ink-2 hover:text-ink-1 hover:bg-surface-4 transition-colors"
        aria-label="Nächstes Foto"
      >
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
          <path d="M7 3l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <!-- Counter -->
      <div
        id="lightbox-counter"
        class="absolute bottom-5 left-1/2 -translate-x-1/2 text-label text-ink-3"
        aria-live="polite"
      ></div>

      <!-- Image -->
      <div class="max-w-5xl max-h-[85vh] mx-auto px-16 sm:px-24">
        <img
          id="lightbox-img"
          src=""
          alt=""
          class="max-w-full max-h-[80vh] object-contain rounded-2xl"
        />
      </div>
    </div>
  </div>
)}

<script>
  function initGallery() {
    const lightbox     = document.getElementById('lightbox');
    const lightboxImg  = document.getElementById('lightbox-img') as HTMLImageElement | null;
    const counter      = document.getElementById('lightbox-counter');
    const closeBtn     = document.getElementById('lightbox-close');
    const prevBtn      = document.getElementById('lightbox-prev');
    const nextBtn      = document.getElementById('lightbox-next');
    const thumbs       = Array.from(document.querySelectorAll<HTMLButtonElement>('.gallery-thumb'));

    if (!lightbox || !lightboxImg || thumbs.length === 0) return;

    let currentIndex = 0;
    const srcs = thumbs.map(t => t.dataset.src ?? '');

    function open(index: number) {
      currentIndex = index;
      lightboxImg!.src = srcs[currentIndex];
      lightboxImg!.alt = `Foto ${currentIndex + 1} von ${srcs.length}`;
      if (counter) counter.textContent = `${currentIndex + 1} / ${srcs.length}`;
      lightbox!.classList.remove('hidden');
      lightbox!.classList.add('flex');
      // trap focus on close button initially
      closeBtn?.focus();
      document.body.style.overflow = 'hidden';
    }

    function close() {
      lightbox!.classList.add('hidden');
      lightbox!.classList.remove('flex');
      document.body.style.overflow = '';
      // return focus to the thumb that opened it
      thumbs[currentIndex]?.focus();
    }

    function goTo(dir: number) {
      currentIndex = (currentIndex + dir + srcs.length) % srcs.length;
      lightboxImg!.src = srcs[currentIndex];
      lightboxImg!.alt = `Foto ${currentIndex + 1} von ${srcs.length}`;
      if (counter) counter.textContent = `${currentIndex + 1} / ${srcs.length}`;
    }

    thumbs.forEach((btn, i) => btn.addEventListener('click', () => open(i)));
    closeBtn?.addEventListener('click', close);
    prevBtn?.addEventListener('click', () => goTo(-1));
    nextBtn?.addEventListener('click', () => goTo(1));

    // Keyboard
    document.addEventListener('keydown', (e) => {
      if (lightbox!.classList.contains('hidden')) return;
      if (e.key === 'Escape') close();
      if (e.key === 'ArrowLeft')  goTo(-1);
      if (e.key === 'ArrowRight') goTo(1);
    });

    // Click outside
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) close();
    });

    // Focus trap
    const focusableEls = [closeBtn, prevBtn, nextBtn].filter(Boolean) as HTMLElement[];
    lightbox.addEventListener('keydown', (e) => {
      if (e.key !== 'Tab') return;
      const first = focusableEls[0];
      const last  = focusableEls[focusableEls.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault(); last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault(); first.focus();
      }
    });
  }

  document.addEventListener('DOMContentLoaded', initGallery);
  document.addEventListener('astro:page-load', initGallery);
</script>
