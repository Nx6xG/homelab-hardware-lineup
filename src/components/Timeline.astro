---
interface TimelineItem {
  slug: string;
  name: string;
  headline: string;
  type: string;
  status: 'online' | 'offline' | 'maintenance' | 'retired';
  date: string;
  event: 'created' | 'updated' | 'retired';
  tags?: string[];
}

interface Props {
  items: TimelineItem[];
  class?: string;
}

const { items, class: className = '' } = Astro.props;

// Short monochrome type labels — no emoji, cleaner on dark glass
const typeLabels: Record<string, string> = {
  'raspberry-pi': 'Pi',
  'server':       'SV',
  'nas':          'NAS',
  'network':      'NET',
  'pc':           'PC',
  'display':      'DP',
  'console':      'CO',
  'smart-home':   'HA',
  'other':        '—',
};

const eventConfig = {
  created: { label: 'Ins Lab aufgenommen', colorClass: 'text-status-online' },
  updated: { label: 'Aktualisiert',        colorClass: 'text-accent'         },
  retired: { label: 'Ausgemustert',        colorClass: 'text-status-retired' },
};

// Group by month/year
const grouped = items.reduce<Record<string, TimelineItem[]>>((acc, item) => {
  const d   = new Date(item.date);
  const key = d.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
  if (!acc[key]) acc[key] = [];
  acc[key].push(item);
  return acc;
}, {});
---

<div class:list={['tl', className]}>
  {Object.entries(grouped).map(([period, periodEvents]) => (
    <div class="tl-group reveal">

      <!-- ── Month heading ── -->
      <div class="tl-period">
        <span class="tl-period-label">{period.toUpperCase()}</span>
        <div class="tl-sep" aria-hidden="true"></div>
      </div>

      <!-- ── Event rail ── -->
      <ul class="tl-rail" role="list">
        {periodEvents.map((item) => {
          const { label, colorClass } = eventConfig[item.event];
          const typeLabel = typeLabels[item.type] ?? '—';
          const dateStr   = new Date(item.date).toLocaleDateString('de-DE', {
            day: 'numeric', month: 'short',
          });

          return (
            <li class="tl-row" role="listitem">

              <!-- Node dot on the rail -->
              <div class="tl-node" data-event={item.event} aria-hidden="true">
                <span class="tl-node-dot"></span>
              </div>

              <!-- Glass card -->
              <a
                href={`/device/${item.slug}`}
                class="tl-card"
                aria-label={`${item.name} — ${label}, ${dateStr}`}
              >
                <!-- Top row: badge + name → [meta on right] -->
                <div class="tl-head">
                  <div class="tl-id">
                    <span class="tl-badge" aria-hidden="true">{typeLabel}</span>
                    <span class="tl-name">{item.name}</span>
                  </div>
                  <div class="tl-meta">
                    <span class:list={['tl-event', colorClass]}>{label}</span>
                    <span class="tl-date">{dateStr}</span>
                  </div>
                </div>

                <!-- Description -->
                <p class="tl-desc">{item.headline}</p>
              </a>

            </li>
          );
        })}
      </ul>

    </div>
  ))}
</div>

<style>
  /* ── Timeline root ── */
  .tl {
    display: flex;
    flex-direction: column;
  }

  /* ── Month group ── */
  .tl-group {
    margin-bottom: 3rem;
  }
  .tl-group:last-child { margin-bottom: 0; }

  /* ── Period heading ── */
  .tl-period {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.25rem;
  }

  .tl-period-label {
    font-size: 0.64rem;
    font-weight: 600;
    letter-spacing: 0.2em;
    color: var(--color-ink-4);
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
  }

  .tl-sep {
    flex: 1;
    height: 1px;
    background: linear-gradient(to right, rgba(255, 255, 255, 0.055), transparent 75%);
  }

  /* ── Rail: vertical line via pseudo ── */
  .tl-rail {
    position: relative;
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
  }

  .tl-rail::before {
    content: '';
    position: absolute;
    left: 5px;           /* center of 12 px node column */
    top: 18px;
    bottom: 18px;
    width: 1px;
    background: linear-gradient(
      to bottom,
      rgba(255, 255, 255, 0.07),
      rgba(255, 255, 255, 0.04) 65%,
      transparent
    );
    pointer-events: none;
  }

  /* ── Row ── */
  .tl-row {
    display: grid;
    grid-template-columns: 12px 1fr;
    gap: 1.125rem;
    align-items: start;
  }

  /* ── Node ── */
  .tl-node {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1.5px solid transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 1.0625rem;   /* optical alignment with card title */
    position: relative;
    z-index: 1;
  }

  .tl-node-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    display: block;
  }

  /* Node variants */
  .tl-node[data-event="created"] {
    border-color: rgba(34, 197, 94, 0.28);
    background:   rgba(34, 197, 94, 0.05);
  }
  .tl-node[data-event="created"] .tl-node-dot {
    background: rgba(34, 197, 94, 0.85);
  }

  .tl-node[data-event="updated"] {
    border-color: rgba(79, 142, 247, 0.28);
    background:   rgba(79, 142, 247, 0.05);
  }
  .tl-node[data-event="updated"] .tl-node-dot {
    background: rgba(79, 142, 247, 0.85);
  }

  .tl-node[data-event="retired"] {
    border-color: rgba(107, 114, 128, 0.22);
    background:   rgba(107, 114, 128, 0.04);
  }
  .tl-node[data-event="retired"] .tl-node-dot {
    background: rgba(107, 114, 128, 0.65);
  }

  /* ── Card ── */
  .tl-card {
    display: block;
    padding: 1.125rem 1.375rem;
    background: rgba(9, 13, 24, 0.72);
    backdrop-filter: blur(16px) saturate(1.3);
    -webkit-backdrop-filter: blur(16px) saturate(1.3);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-card);
    box-shadow:
      0 1px 3px rgba(0, 0, 0, 0.42),
      inset 0 1px 0 rgba(255, 255, 255, 0.04);
    text-decoration: none;
    transition:
      transform    300ms cubic-bezier(0.16, 1, 0.3, 1),
      border-color 300ms ease-out,
      box-shadow   300ms ease-out;
  }

  .tl-card:hover {
    transform: translateY(-2px);
    border-color: rgba(79, 142, 247, 0.15);
    box-shadow:
      0 0 0 1px rgba(79, 142, 247, 0.05),
      0 8px 28px rgba(0, 0, 0, 0.28),
      0 0 36px rgba(79, 142, 247, 0.05),
      inset 0 1px 0 rgba(255, 255, 255, 0.055);
  }

  .tl-card:focus-visible {
    outline: 2px solid rgba(79, 142, 247, 0.5);
    outline-offset: 3px;
    border-radius: var(--radius-card);
  }

  /* ── Card head ── */
  .tl-head {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .tl-id {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    min-width: 0;
  }

  /* Type badge — monospace, minimal */
  .tl-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 20px;
    padding: 0 0.35rem;
    border-radius: 4px;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    font-family: ui-monospace, 'SF Mono', monospace;
    color: var(--color-ink-3);
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.06);
    flex-shrink: 0;
  }

  .tl-name {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-ink-1);
    letter-spacing: -0.012em;
    line-height: 1.25;
  }

  /* Right-side meta */
  .tl-meta {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    flex-shrink: 0;
    padding-top: 0.1rem; /* optical alignment */
  }

  .tl-event {
    font-size: 0.72rem;
    font-weight: 500;
    white-space: nowrap;
  }

  .tl-date {
    font-size: 0.72rem;
    color: var(--color-ink-4);
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }

  /* Description — indent aligns with name */
  .tl-desc {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.47);
    line-height: 1.65;
    padding-left: calc(28px + 0.625rem);
  }

  /* ── Mobile: meta below name ── */
  @media (max-width: 499px) {
    .tl-head {
      flex-direction: column;
      gap: 0.375rem;
    }
    .tl-meta {
      padding-top: 0;
      padding-left: calc(28px + 0.625rem);
    }
    .tl-desc {
      margin-top: 0.25rem;
    }
  }

  /* ── Reduced motion ── */
  @media (prefers-reduced-motion: reduce) {
    .tl-card {
      transition: border-color 300ms ease-out, box-shadow 300ms ease-out;
    }
    .tl-card:hover { transform: none; }
  }
</style>
